name: Version Update and Upload Python Package

# Disabled attestations to correct errors on upload.
# https://github.com/pypa/gh-action-pypi-publish/issues/283

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        ref: master

    - name: Get the version of the release and the current version
      id: set_version
      run: |
        echo "::set-output name=release_version::${GITHUB_REF##refs/tags/v}"
        echo "::set-output name=base_version::$(python -c 'from utils.release import get_version; print(get_version())')"

    - name: Commit the version update
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git pull origin master
        python utils/release.py --update_version ${{ steps.set_version.outputs.release_version }}
        git add .
        git commit -m "Update version from ${{ steps.set_version.outputs.base_version }} to ${{ steps.set_version.outputs.release_version }}"
        git push origin master
        
