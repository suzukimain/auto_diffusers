name: Operation Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  operation-check:
    name: Check pipeline operation
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          pip install -U torch --index-url https://download.pytorch.org/whl/cpu

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            pip install -e .
          else
            pip install -U auto_diffusers
          fi

      - name: Test import
        run: python -c "from auto_diffusers import *"

      - name: Test from_huggingface
        id: hf_test
        continue-on-error: true
        run: |
          python - <<'EOF'
          from auto_diffusers import EasyPipelineForText2Image
          EasyPipelineForText2Image.from_huggingface("Stable Diffusion")
          EOF

      - name: Test from_civitai
        id: civitai_test
        continue-on-error: true
        run: |
          python - <<'EOF'
          from auto_diffusers import EasyPipelineForText2Image
          EasyPipelineForText2Image.from_civitai("Anything", base_model="SD 1.5")
          EOF

      - name: Evaluate results
        run: |
          if [ "${{ steps.hf_test.outcome }}" = "failure" ] || \
             [ "${{ steps.civitai_test.outcome }}" = "failure" ]; then
            echo "::error::Operation check failed"
            exit 1
          fi
          echo "::notice::All tests passed"

  create-issue-for-copilot:
    name: Create issue and assign Copilot
    needs: operation-check
    if: needs.operation-check.result == 'failure'
    runs-on: ubuntu-22.04

    permissions:
      issues: write
      contents: read
      pull-requests: write

    steps:
      - name: Create issue and assign Copilot
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues \
            --input - <<'EOF'
          {
            "title": "Operation Check failed (auto)",
            "body": "The scheduled operation check failed.\n\nPlease analyze the failure and create a pull request that fixes the root cause.",
            "assignees": ["copilot-swe-agent[bot]"],
            "agent_assignment": {
              "target_repo": "${{ github.repository }}",
              "base_branch": "main",
              "custom_instructions": "Fix the failing operation check. Focus on Hugging Face / Civitai pipeline robustness and add regression safety if needed."
            }
          }
          EOF
