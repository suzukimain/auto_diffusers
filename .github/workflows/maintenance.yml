name: Operation Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  operation-check:
    runs-on: ubuntu-22.04
    outputs:
      check_failed: ${{ env.CHECK_FAILED }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -U torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e .

      - name: Init result flags
        run: |
          echo "HF_OK=true" >> "$GITHUB_ENV"
          echo "CIVITAI_OK=true" >> "$GITHUB_ENV"

      - name: Test import
        run: |
          set +e
          python -c "import auto_diffusers" 2>&1 | tee import.log
          echo "IMPORT_RC=$?" >> "$GITHUB_ENV"

      - name: Test from_huggingface
        run: |
          set +e
          python - <<'EOF' 2>&1 | tee hf.log
          from auto_diffusers import EasyPipelineForText2Image
          EasyPipelineForText2Image.from_huggingface("Stable Diffusion")
          EOF
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "HF_OK=false" >> "$GITHUB_ENV"
          fi

      - name: Test from_civitai
        run: |
          set +e
          python - <<'EOF' 2>&1 | tee civitai.log
          from auto_diffusers import EasyPipelineForText2Image
          EasyPipelineForText2Image.from_civitai("Anything", base_model="SD 1.5")
          EOF
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "CIVITAI_OK=false" >> "$GITHUB_ENV"
          fi

      - name: Collect logs
        run: |
          {
            echo "HF_OK=${HF_OK}"
            echo "CIVITAI_OK=${CIVITAI_OK}"
            echo
            echo "===== import.log ====="
            cat import.log || true
            echo
            echo "===== hf.log ====="
            cat hf.log || true
            echo
            echo "===== civitai.log ====="
            cat civitai.log || true
          } > failure.log

      - uses: actions/upload-artifact@v4
        with:
          name: operation-check-log
          path: failure.log

      - name: Final judge
        run: |
          if [ "${HF_OK}" = "false" ] || [ "${CIVITAI_OK}" = "false" ]; then
            echo "CHECK_FAILED=true" >> "$GITHUB_ENV"
          else
            echo "CHECK_FAILED=false" >> "$GITHUB_ENV"
          fi

  create-issue:
    needs: operation-check
    runs-on: ubuntu-22.04
    if: needs.operation-check.outputs.check_failed == 'true'

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: operation-check-log

      - name: Create or update issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          FAIL_HASH=$(sha256sum failure.log | cut -d' ' -f1)
          TITLE="Operation Check failed [hash:${FAIL_HASH}]"

          BODY=$(cat <<EOF
          Operation Check failed.

          **HF_OK:** ${HF_OK}  
          **CIVITAI_OK:** ${CIVITAI_OK}  

          <details>
          <summary>Logs</summary>

          \`\`\`
          $(cat failure.log)
          \`\`\`
          </details>
          EOF
          )

          EXISTING=$(gh issue list \
            --state open \
            --search "hash:${FAIL_HASH}" \
            --json number \
            -q '.[0].number')

          if [ -n "$EXISTING" ]; then
            gh issue comment "$EXISTING" --body "$BODY"
          else
            gh issue create \
              --title "$TITLE" \
              --body "$BODY"
          fi
