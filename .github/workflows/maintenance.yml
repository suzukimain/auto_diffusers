name: Operation Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  operation-check:
    name: Check pipeline operation
    runs-on: ubuntu-22.04

    outputs:
      hf_ok: ${{ steps.judge.outputs.hf_ok }}
      civitai_ok: ${{ steps.judge.outputs.civitai_ok }}

    steps:
      - name: Checkout source
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -U torch --index-url https://download.pytorch.org/whl/cpu

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            pip install -e .
          else
            pip install -U auto_diffusers
          fi

      - name: Initialize result flags
        run: |
          echo "HF_OK=true" >> "$GITHUB_ENV"
          echo "CIVITAI_OK=true" >> "$GITHUB_ENV"

      - name: Test import
        run: |
          python -c "import auto_diffusers" 2>&1 | tee import.log

      - name: Test from_huggingface
        continue-on-error: true
        run: |
          python - <<'EOF' 2>&1 | tee hf.log
          from auto_diffusers import EasyPipelineForText2Image
          try:
              EasyPipelineForText2Image.from_huggingface("Stable Diffusion")
          except Exception as e:
              print("HF ERROR:", e)
              raise
          EOF || echo "HF_OK=false" >> "$GITHUB_ENV"

      - name: Test from_civitai
        continue-on-error: true
        run: |
          python - <<'EOF' 2>&1 | tee civitai.log
          from auto_diffusers import EasyPipelineForText2Image
          try:
              EasyPipelineForText2Image.from_civitai(
                  "Anything",
                  base_model="SD 1.5",
              )
          except Exception as e:
              print("CIVITAI ERROR:", e)
              raise
          EOF || echo "CIVITAI_OK=false" >> "$GITHUB_ENV"

      - name: Collect logs
        run: |
          {
            echo "HF_OK=${HF_OK}"
            echo "CIVITAI_OK=${CIVITAI_OK}"
            echo
            echo "===== import.log ====="
            cat import.log || true
            echo
            echo "===== hf.log ====="
            cat hf.log || true
            echo
            echo "===== civitai.log ====="
            cat civitai.log || true
          } > operation.log

      - name: Judge result
        id: judge
        run: |
          echo "hf_ok=${HF_OK}" >> "$GITHUB_OUTPUT"
          echo "civitai_ok=${CIVITAI_OK}" >> "$GITHUB_OUTPUT"

      - name: Upload operation log
        uses: actions/upload-artifact@v4
        with:
          name: operation-check-log
          path: operation.log

  create-issue-on-failure:
    name: Create or update issue
    needs: operation-check
    if: needs.operation-check.outputs.hf_ok == 'false' || needs.operation-check.outputs.civitai_ok == 'false'
    runs-on: ubuntu-22.04

    permissions:
      issues: write
      contents: read

    steps:
      - name: Download operation log
        uses: actions/download-artifact@v4
        with:
          name: operation-check-log

      - name: Create or update issue (deduplicated)
        env:
          GH_TOKEN: ${{ github.token }}
          HF_OK: ${{ needs.operation-check.outputs.hf_ok }}
          CIVITAI_OK: ${{ needs.operation-check.outputs.civitai_ok }}
        run: |
          set -e

          FAIL_HASH=$(echo "${HF_OK}:${CIVITAI_OK}" | sha256sum | cut -d' ' -f1)
          TITLE="Operation Check failed [hash:${FAIL_HASH}]"

          BODY=$(cat <<'EOF'
          Operation Check detected failure.

          HF_OK: __HF_OK__
          CIVITAI_OK: __CIVITAI_OK__

          <details>
          <summary>Operation log</summary>

