name: Operation Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  schedule:
    - cron: '0 22 * * *'

  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch / tag / SHA to test (empty => PyPI package)'
        required: false
        default: ''
      break_yaml:
        description: 'INTENTIONAL break for testing (none|hf|civitai|final)'
        required: false
        default: 'none'

jobs:
  operation-check:
    name: Check pipeline operation
    runs-on: ubuntu-22.04

    steps:
      # ---------------- Checkout (source only) ----------------
      - name: Checkout source
        if: github.event_name == 'workflow_dispatch' && inputs.ref != ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      # ---------------- Python ----------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------- Dependencies ----------------
      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          pip install -U torch --index-url https://download.pytorch.org/whl/cpu

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.ref }}" != "" ]; then
            echo "Installing auto_diffusers from source: ${{ inputs.ref }}"
            pip install -e .
          else
            echo "Installing auto_diffusers from PyPI"
            pip install -U auto_diffusers
          fi

      # ---------------- Sanity ----------------
      - name: Testing Import
        run: python -c "from auto_diffusers import *"

      # ---------------- HF ----------------
      - name: Check from_huggingface
        id: hf_test
        continue-on-error: true
        run: |
          if [ "${{ inputs.break_yaml }}" = "hf" ]; then
            echo "::error::INTENTIONAL BREAK: HuggingFace step forced failure"
            exit 42
          fi

          python - <<'EOF'
          from auto_diffusers import EasyPipelineForText2Image
          EasyPipelineForText2Image.from_huggingface("Stable Diffusion")
          EOF

      - name: Record HF result
        run: |
          if [ "${{ steps.hf_test.outcome }}" = "success" ]; then
            echo "HF_RESULT=success" >> $GITHUB_ENV
          else
            echo "HF_RESULT=failure" >> $GITHUB_ENV
          fi

      - name: Clean Hugging Face cache
        run: rm -rf ~/.cache/huggingface/hub/* || true

      # ---------------- Civitai ----------------
      - name: Check from_civitai
        id: civitai_test
        continue-on-error: true
        run: |
          if [ "${{ inputs.break_yaml }}" = "civitai" ]; then
            echo "::error::INTENTIONAL BREAK: Civitai step forced failure"
            exit 43
          fi

          python - <<'EOF'
          from auto_diffusers import EasyPipelineForText2Image
          EasyPipelineForText2Image.from_civitai("Anything", base_model="SD 1.5")
          EOF

      - name: Record Civitai result
        run: |
          if [ "${{ steps.civitai_test.outcome }}" = "success" ]; then
            echo "CIVITAI_RESULT=success" >> $GITHUB_ENV
          else
            echo "CIVITAI_RESULT=failure" >> $GITHUB_ENV
          fi

      # ---------------- Final ----------------
      - name: Final evaluation
        run: |
          echo "HF_RESULT=${HF_RESULT}"
          echo "CIVITAI_RESULT=${CIVITAI_RESULT}"

          if [ "${{ inputs.break_yaml }}" = "final" ]; then
            echo "::error::INTENTIONAL BREAK: Final evaluation forced failure"
            exit 44
          fi

          if [ "$HF_RESULT" = "failure" ] || [ "$CIVITAI_RESULT" = "failure" ]; then
            echo "One or more checks failed"
            exit 1
          fi

  # ---------------- Copilot Auto Fix ----------------
  copilot-auto-fix:
    name: Copilot Auto Fix & Summary PR
    needs: operation-check
    if: needs.operation-check.result == 'failure'
    runs-on: ubuntu-22.04

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Run Copilot Coding Agent
        uses: github/copilot-coding-agent@v1
        with:
          task: |
            The workflow failed.

            IMPORTANT:
            If logs contain "INTENTIONAL BREAK",
            this failure was introduced on purpose to test the workflow.
            Do NOT attempt to fix intentional breaks.

            Test summary:
            - HuggingFace: ${{ env.HF_RESULT }}
            - Civitai: ${{ env.CIVITAI_RESULT }}

            Only report whether detection and aggregation behaved correctly.

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "[Copilot] Fix Operation Check failure (summary)"
          commit-message: "fix: stabilize operation check workflow"
          body: |
            This PR was automatically generated by GitHub Copilot Coding Agent.

            Test results:
            - HuggingFace: ${{ env.HF_RESULT }}
            - Civitai: ${{ env.CIVITAI_RESULT }}

            Note:
            If logs contain "INTENTIONAL BREAK", this PR should be reviewed
            only for workflow behavior, not for fixing code.
          branch: copilot/operation-check-fix
